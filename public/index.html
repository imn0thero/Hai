<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h2 id="welcome">Welcome</h2>
      <button id="darkModeToggle">üåô</button>
    </div>
    <div class="chat-box" id="chatBox"></div>
    <form id="messageForm">
      <input type="text" id="messageInput" placeholder="Type a message..." required>
      <button type="submit">‚ñ∂Ô∏è</button>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const messageForm = document.getElementById("messageForm");
    const messageInput = document.getElementById("messageInput");
    const chatBox = document.getElementById("chatBox");
    const welcome = document.getElementById("welcome");
    const darkToggle = document.getElementById("darkModeToggle");

    let username = localStorage.getItem("username");
    if (!username) window.location.href = "/login.html";
    welcome.innerText = `Welcome, ${username}`;

    function addMessage(data) {
      const div = document.createElement("div");
      div.classList.add("message");
      div.classList.add(data.user === username ? "sender" : "receiver");
      div.innerHTML = `<strong>${data.user === username ? "You" : data.user}:</strong> ${data.text}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    socket.emit("login", { username, password: localStorage.getItem("password") });

    socket.on("loginResult", res => {
      if (!res.success) {
        alert(res.message);
        localStorage.clear();
        window.location.href = "/login.html";
      } else {
        res.messages.forEach(addMessage);
      }
    });

    socket.on("message", addMessage);

    messageForm.addEventListener("submit", e => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (text) {
        socket.emit("message", { text });
        messageInput.value = "";
      }
    });

    // Dark Mode
    function applyTheme(theme) {
      document.body.classList.toggle("dark", theme === "dark");
      darkToggle.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
    }
    darkToggle.addEventListener("click", () => {
      const t = document.body.classList.contains("dark") ? "light" : "dark";
      localStorage.setItem("theme", t);
      applyTheme(t);
    });
    applyTheme(localStorage.getItem("theme") || "light");
  </script>
</body>
</html>
