<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Beranda</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2>Daftar Chat</h2>
    <input type="text" id="searchInput" placeholder="Cari username..." />
    <ul id="searchResults"></ul>

    <h3>Chat Sebelumnya</h3>
    <ul id="chatList"></ul>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const username = localStorage.getItem("username");
    if (!username) {
      window.location.href = "login.html";
    }

    const socket = io();
    socket.emit("user_connected", username);

    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");
    const chatList = document.getElementById("chatList");

    async function loadUsers() {
      const res = await fetch("/api/users");
      const users = await res.json();

      searchInput.addEventListener("input", () => {
        const val = searchInput.value.toLowerCase();
        searchResults.innerHTML = "";
        users
          .filter(u => u !== username && u.toLowerCase().includes(val))
          .forEach(u => {
            const li = document.createElement("li");
            li.textContent = u;
            li.onclick = () => {
              window.location.href = `chat.html?with=${u}`;
            };
            searchResults.appendChild(li);
          });
      });

      loadChatList(users);
    }

    async function loadChatList(users) {
      const res = await fetch("/api/messages");
      const messages = await res.json();
      const userMap = {};

      messages.forEach(msg => {
        const other = msg.from === username ? msg.to : msg.from;
        if (!userMap[other] || new Date(msg.timestamp) > new Date(userMap[other].timestamp)) {
          userMap[other] = msg;
        }
      });

      Object.keys(userMap).forEach(user => {
        const li = document.createElement("li");
        li.textContent = `${user}: ${userMap[user].text}`;
        li.onclick = () => {
          window.location.href = `chat.html?with=${user}`;
        };
        chatList.appendChild(li);
      });
    }

    loadUsers();
  </script>
</body>
</html>
