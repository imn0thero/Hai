<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <link rel="stylesheet" href="style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <h2>Chat dengan <span id="peer"></span></h2>
    <div id="chatBox" class="chat-box"></div>
    <input type="text" id="message" placeholder="Tulis pesan">
    <button onclick="sendMessage()">Kirim</button>
    <button onclick="clearChat()">Hapus Semua</button>
    <button onclick="back()">Kembali</button>
  </div>
<script>
if (!localStorage.getItem('user') || !localStorage.getItem('peer')) location.href = 'index.html';

const socket = io();
const me = localStorage.getItem('user');
const peer = localStorage.getItem('peer');
document.getElementById('peer').innerText = peer;
const pairKey = [me, peer].sort().join('_');

socket.emit('register', me);

socket.on('message', showMessage);

function loadMessages() {
  fetch('/messages/' + pairKey)
    .then(res => res.json())
    .then(data => {
      document.getElementById('chatBox').innerHTML = '';
      const now = Date.now();
      data.filter(m => now - m.timestamp < 86400000)
          .forEach(showMessage);
    });
}

function showMessage(msg) {
  if ([msg.from, msg.to].includes(me) && [msg.from, msg.to].includes(peer)) {
    const div = document.createElement('div');
    div.className = 'bubble ' + (msg.from === me ? 'right' : 'left');
    div.textContent = msg.text;
    document.getElementById('chatBox').appendChild(div);
    document.getElementById('chatBox').scrollTop = 999999;
  }
}

function sendMessage() {
  const text = document.getElementById('message').value;
  if (!text.trim()) return;
  socket.emit('private-message', { from: me, to: peer, text });
  document.getElementById('message').value = '';
}

function clearChat() {
  fetch('/messages/' + pairKey + '/clear', { method: 'POST' })
    .then(() => loadMessages());
}

function back() {
  localStorage.removeItem('peer');
  window.location.href = 'index.html';
}

loadMessages();
</script>
</body>
</html>
